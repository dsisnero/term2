# Workstream Definition: Crystal Idioms & API Ergonomics
# Exploring advanced Crystal capabilities to make Term2 code more concise, idiomatic, and "Ruby-like"

workstream:
  id: "crystal-idioms"
  title: "Crystal Idioms & API Ergonomics"
  letter: "C"
  status: "active"
  priority: 2
  created_at: "2025-11-25T00:00:00Z"
  updated_at: "2025-11-25T00:00:00Z"

assignment:
  assigned_agent: "term2-architect"
  agent_type: "specialist"
  required_skills: ["crystal", "metaprogramming", "api-design"]
  estimated_completion: "2025-12-15"

dependencies:
  blocks: []
  blocked_by: []
  depends_on: []
  related_to: ["bubbles-components"]

requirements:
  prerequisites:
    - "term2_core_stable"
  acceptance_criteria:
    - "Prototyped at least 3 different API styles"
    - "Implemented a View DSL that reduces boilerplate"
    - "Created macros for common Application patterns"
    - "Documentation comparing new vs old API"

tasks:
  - id: "research-prototypes"
    description: "Research and prototype different API styles"
    status: "completed"
    priority: 1
    estimated_hours: 8
    actual_hours: 2
    dependencies: []
    acceptance_criteria:
      - "Create `temp/api_experiments.cr`"
      - "Try block-based initialization"
      - "Try macro-based message handling"
      - "Explore 'magic' message routing (e.g. `on KeyMsg`)"
    notes: "Focus on 'Ruby-like' elegance and hiding complexity. Found that `Application(M)` solves the casting issue. Macros proved difficult for `update` logic due to Crystal syntax limitations."

  - id: "view-dsl"
    description: "Design and implement a View DSL"
    status: "completed"
    priority: 2
    estimated_hours: 12
    actual_hours: 3
    dependencies: ["research-prototypes"]
    acceptance_criteria:
      - "Builder pattern for views (e.g. `View.v_stack { ... }`)"
      - "Automatic string building context"
      - "Integration with styling DSL"
      - "Layout primitives (Row, Column, Center)"
    notes: "Implemented `Layout.render`, `v_stack`, `h_stack`, `border`, `padding`, and `text`. Verified with `examples/layout_dsl_example.cr`."

  - id: "app-macros"
    description: "Macros for Application boilerplate"
    status: "completed"
    priority: 2
    estimated_hours: 8
    actual_hours: 2
    dependencies: ["research-prototypes"]
    acceptance_criteria:
      - "Macro for `update` switching on message type"
      - "Simplified `main` entry point"
      - "DSL for defining model properties"
      - "Eliminate need for `model.as(MyModel)` casting in update/view"
    notes: "Pivoted from complex macros to using Generics (`Application(M)`) which solves the casting issue cleanly. Abandoned `def_update` macros due to fragility."

  - id: "component-embedding"
    description: "Simplify component embedding"
    status: "completed"
    priority: 3
    estimated_hours: 8
    actual_hours: 4
    dependencies: ["app-macros"]
    acceptance_criteria:
      - "Easy delegation of update/view to components"
      - "Automatic model wrapping/unwrapping"
      - "Macros for mounting components"
    notes: "Implemented Bubble Tea style composition. Components return `Layout::Node` (via `render`) which can be embedded in parent layouts using `add`. Verified in `examples/comprehensive_demo.cr`."

progress:
  total_tasks: 4
  completed_tasks: 4
  blocked_tasks: 0
  completion_percentage: 100
  last_progress_update: "2025-11-25T00:00:00Z"

oracle_insights:
  strategic_importance: "high"
  complexity: "high"
  risk_level: "medium"
  optimization_suggestions:
    - "Look at Lucky framework or Kemal for DSL inspiration"
    - "Don't over-abstract; keep the Elm architecture visible but cleaner"
    - "Consider using `method_missing` or macros for dynamic message dispatch"

links:
  plan_reference: "plans/README.md"
  related_files:
    - "src/term2.cr"
    - "src/view.cr"
  documentation: []
